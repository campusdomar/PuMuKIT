{% if multimediaObject.getEmbeddedEvent() and multimediaObject.getEmbeddedEvent().isChatEnabled() %}
{% set event = multimediaObject.getEmbeddedEvent() %}
<link href="{{ asset('bundles/pumukitlive/css/chat.css') }}" type="text/css" rel="stylesheet" media="screen"/>
<div class="panel panel-default panel-related event-chat-panel">
  <div class="panel-heading">
    {% trans %}Event chat{% endtrans %}
  </div>
  <div class="panel-body" style="height:200px;">
    <div id="chatList" style="overflow: hidden;">
      {% render(controller('PumukitLiveBundle:Chat:list', {'id': multimediaObject.id})) %}
    </div>
  </div>
  <div class="panel-footer">
    <form id="chatForm" onsubmit="postChatMessage(); return false;" action="{{ path('pumukit_live_chat_post', {'id': multimediaObject.id}) }}" method="post">
      <div>
        <label for="name">{% trans %}Name{% endtrans %}:</label>
        <input type="text" name="name" id="chatName" maxlength="30" class="chatForm" value="{{ username }}"/>
      </div>
      <div>
        <label for="name">{% trans %}Message{% endtrans %}:</label>
        <input type="textarea" name="message" id="chatMessage" wrap="virtual" class="chatForm chatInputMessage" value=""/>
      </div>
    </form>    
  </div>
</div>


<script type="text/javascript">
var chat_timer = null;
document.addEventListener('DOMContentLoaded', function() {
   $('#chatMessage').on('keypress', function(e){
      var code = e.keyCode || e.which;
      if (code == 13) {
         postChatMessage();
         e.preventDefault();
      }
   });
});
postChatMessage = function()
{
    if ($("#chatName").val() != '') {
        var route = "{{ path('pumukit_live_chat_post', {'id': multimediaObject.id})|raw }}";
        var name = $("#chatName").val();
        var message = $("#chatMessage").val();
        $.ajax({
           url: route,
           type: 'POST',
           data: {'method': 'POST', 'name': name, 'message': message},
           error: function(jqXHR, textStatus, errorThrown) {
           },
           success: function(data, textStatus, jqXHR) {
              if (data != '') {
                  var message = data.message;
                  if (message === 'Successful') {
                      $("#chatMessage").val('');
                      updateChat();
                  }
              }
           }
        });
        $("#chatMessage").val('');
    } else {
        window.alert("{% trans %}Name cannot be empty{% endtrans %}");
    }
    return false;
}
updateChat = function()
{
    if (chat_timer != null)
        clearTimeout(chat_timer);
    $('#chatList').load("{{ path('pumukit_live_chat_list', {'id': multimediaObject.id}) }}", function(response, status, xhr) {
        if (status == "error") {
            console.log("Sorry but there was an error: ");
        } else {
            scrolldownChat();
        }
    }); 
    chat_timer = setTimeout('updateChat()', {{ chatUpdateInterval }});
}
scrolldownChat = function()
{
    var chatDiv = document.getElementById('chatDiv');
    chatDiv.scrollTop = chatDiv.scrollHeight;
}
updateChat();
</script>
{% endif %}
